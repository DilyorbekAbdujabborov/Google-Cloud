<!DOCTYPE html>
<html lang="uz" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyDrive â€“ Fayl boshqaruvi</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Vend Sans'],
              mono: ['Libertinus Keyboard', 'ui-monospace', 'SFMono-Regular'],
            },
          },
        },
      };
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Libertinus+Keyboard&family=Vend+Sans:ital,wght@0,300..700;1,300..700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="min-h-screen bg-gray-50">
    <div class="max-w-6xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
      <!-- Sarlavha -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900">
          <a
            href="#"
            target="_blank"
            class="text-indigo-600 hover:text-indigo-700 transition"
          >
            MyDrive Cloud
          </a>
        </h1>
        <p class="mt-3 text-xl text-gray-600">
          Google Drive orqali fayllarni xavfsiz saqlash va ulashish
        </p>
        <a
          href="/auth/logout"
          class="absolute top-0 right-0 mt-4 mr-4 px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition"
        >
          Logout
        </a>
      </div>

      <!-- Fayl yuklash bo'limi -->
      <div
        class="bg-white rounded-3xl shadow-xl p-10 mb-12 border border-gray-100"
      >
        <h2 class="text-3xl font-semibold text-gray-800 mb-8">
          Yangi fayl yuklash
        </h2>
        <div class="flex flex-col lg:flex-row gap-6 items-center">
          <input
            id="file"
            type="file"
            class="block w-full text-lg text-gray-700 file:mr-6 file:py-4 file:px-8 file:rounded-full file:border-0 file:text-lg file:font-medium file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer transition"
          />
          <button
            onclick="upload()"
            class="px-10 py-4 bg-indigo-600 text-white text-lg font-semibold rounded-full hover:bg-indigo-700 transition shadow-lg hover:shadow-xl whitespace-nowrap"
          >
            Yuklash
          </button>
        </div>

        <!-- Progress -->
        <div class="mt-8">
          <div
            id="progress"
            class="h-4 bg-gray-200 rounded-full overflow-hidden hidden"
          >
            <div
              class="h-full bg-indigo-600 transition-all duration-300"
              style="width: 0%"
            ></div>
          </div>
          <p
            id="progressText"
            class="mt-3 text-lg font-medium text-indigo-600 text-center hidden"
          >
            0%
          </p>
        </div>
      </div>

      <!-- Fayllar ro'yxati -->
      <div
        class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100"
      >
        <div class="px-10 py-8 bg-gradient-to-r from-indigo-600 to-purple-600">
          <h2 class="text-3xl font-bold text-white">
            Mening fayllarim (MyDrive Cloud papkasida)
          </h2>
        </div>
        <div id="list" class="divide-y divide-gray-200">
          <div class="p-16 text-center text-gray-500 text-xl">
            Yuklangan fayllar shu yerda ko'rinadi...
          </div>
        </div>
      </div>
    </div>

    <script>
      const API = '/files';
      const WEB_BASE = window.location.origin + '/files/web/';

      // Fayl yuklash
      async function upload() {
        const input = document.getElementById('file');
        const file = input.files[0];
        if (!file) return alert('Iltimos, fayl tanlang!');

        const progressBar = document.getElementById('progress');
        const progressFill = progressBar.querySelector('div');
        const progressText = document.getElementById('progressText');

        progressBar.classList.remove('hidden');
        progressText.classList.remove('hidden');
        progressFill.style.width = '0%';
        progressText.textContent = '0%';

        const fd = new FormData();
        fd.append('file', file);

        const xhr = new XMLHttpRequest();

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = percent + '%';
            progressText.textContent = percent + '%';
          }
        };

        xhr.onload = () => {
          progressBar.classList.add('hidden');
          progressText.classList.add('hidden');
          if (xhr.status === 200 || xhr.status === 201) {
            input.value = '';
            load();
          } else if (xhr.status === 401) {
            window.location.href = '/auth/google';
          } else {
            alert(
              'Xato: ' +
                (JSON.parse(xhr.responseText)?.error || 'Yuklashda muammo')
            );
          }
        };

        xhr.open('POST', API);
        xhr.send(fd);
      }

      // Fayllarni yuklash
      async function load() {
        try {
          const r = await fetch(API);
          if (r.status === 401) return (window.location.href = '/auth/google');
          if (!r.ok) throw new Error('Server xatosi: ' + r.status);

          const data = await r.json();
          const list = document.getElementById('list');
          list.innerHTML = '';

          if (!data || data.length === 0) {
            list.innerHTML = `<div class="p-20 text-center text-gray-500 text-2xl">Hozircha hech qanday fayl yuklanmagan ğŸ˜”</div>`;
            return;
          }

          data.forEach((x) => {
            const id = x._id;
            const originalName = x.originalName || 'Nomsiz fayl';
            const size = x.size || 0;
            const uploadedAt = x.uploadedAt || Date.now();

            const ext = originalName.split('.').pop()?.toLowerCase() || '';
            const icons = {
              pdf: 'ğŸ“„',
              doc: 'ğŸ“',
              docx: 'ğŸ“',
              txt: 'ğŸ“„',
              jpg: 'ğŸ–¼ï¸',
              jpeg: 'ğŸ–¼ï¸',
              png: 'ğŸ–¼ï¸',
              gif: 'ğŸ–¼ï¸',
              webp: 'ğŸ–¼ï¸',
              mp4: 'ğŸ¥',
              mov: 'ğŸ¥',
              mp3: 'ğŸµ',
              wav: 'ğŸµ',
              zip: 'ğŸ“¦',
              rar: 'ğŸ“¦',
              '7z': 'ğŸ“¦',
              xls: 'ğŸ“Š',
              xlsx: 'ğŸ“Š',
              csv: 'ğŸ“Š',
            };
            const icon = icons[ext] || 'ğŸ“';

            const div = document.createElement('div');
            div.className =
              'px-10 py-8 hover:bg-gray-50 transition flex flex-col lg:flex-row lg:items-center justify-between gap-6';
            div.innerHTML = `
              <div class="flex items-center space-x-6">
                <span class="text-5xl">${icon}</span>
                <div>
                  <div class="text-xl font-semibold text-gray-900 truncate max-w-xl">${originalName}</div>
                  <div class="text-gray-500">
                    ${formatBytes(size)} â€¢ ${new Date(
              uploadedAt
            ).toLocaleDateString('uz-UZ', {
              day: '2-digit',
              month: 'long',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            })}
                  </div>
                </div>
              </div>

              <div class="flex flex-wrap gap-3 justify-center lg:justify-end">
                <a href="/files/${id}/preview" target="_blank" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-xl hover:bg-blue-700 transition">Ko'rish</a>
                <a href="/files/${id}/download" target="_blank" class="px-6 py-3 bg-green-600 text-white font-medium rounded-xl hover:bg-green-700 transition">Yuklab olish</a>
                <button onclick="copyWebLink('${id}')" class="px-6 py-3 bg-purple-600 text-white font-medium rounded-xl hover:bg-purple-700 transition flex items-center gap-2"><span>ğŸ”— Web Link</span></button>
                <button onclick="del('${id}')" class="px-6 py-3 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 transition">O'chirish</button>
              </div>
            `;
            list.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          document.getElementById(
            'list'
          ).innerHTML = `<div class="p-10 text-center text-red-600 text-xl">Xatolik: ${err.message}</div>`;
        }
      }

      // Web link nusxalash
      function copyWebLink(id) {
        const link = WEB_BASE + id;
        navigator.clipboard
          .writeText(link)
          .then(() => {
            alert(
              'âœ… Web havola nusxalandi!\n\n' +
                link +
                '\n\nEndi uni istalgan odamga yuborishingiz mumkin â€“ fayl darrov ochiladi!'
            );
          })
          .catch(() => {
            prompt('Havolani nusxalang:', link);
          });
      }

      // O'chirish
      async function del(id) {
        if (!confirm('Bu faylni butunlay oÊ»chirishni xohlaysizmi?')) return;
        const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
        if (res.status === 401) window.location.href = '/auth/google';
        else load();
      }

      // Hajm formatlash
      function formatBytes(bytes, decimals = 2) {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]
        );
      }

      // Sahifa yuklanganda fayllarni ko'rsatish va polling
      load();
      setInterval(load, 5000); // 5 soniyada yangilash
    </script>
  </body>
</html>
